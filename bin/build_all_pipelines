#!/bin/bash

mkdir -p build

# Start from empty if we don't have intermediate build artifacts cached
if [ ! -f intermediate/all_pipelines.ndjson ]; then
  touch intermediate/all_pipelines.ndjson
fi

# 1. Join to pipelines we're already downloaded
# 2. Skip the counties we've already downloaded pipelines for
# 3. Batch only 500 at a time
# 4. Download the pipelines
# 5. Output to ndjson
ndjson-join --left 'd.id' 'd.properties.county_fips' intermediate/counties-points.ndjson intermediate/all_pipelines.ndjson \
  | ndjson-filter '!d[1]' \
  | ndjson-map 'd[0]' \
  | head -n 500 \
  | bin/pipeline_pipe \
  >> intermediate/all_pipelines.ndjson
